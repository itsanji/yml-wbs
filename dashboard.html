<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip.com Crawler - Project Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            overflow: hidden;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            overflow: hidden;
        }

        .card-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #374151;
        }

        .card-content {
            padding: 1.5rem;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab:hover {
            background: #e2e8f0;
        }

        .tab.active {
            border-bottom-color: #667eea;
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .task-item:hover {
            background: #f8fafc;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .status-complete { background: #10b981; }
        .status-partial { background: #f59e0b; }
        .status-not-started { background: #ef4444; }

        .task-info {
            flex: 1;
        }

        .task-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .task-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .task-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .task-hours {
            text-align: right;
            min-width: 120px;
            padding: 8px;
        }
        
        .hours-display {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .actual-hours {
            color: #059669;
            font-weight: 700;
        }
        
        .hours-separator {
            color: #6b7280;
            margin: 0 2px;
        }
        
        .planned-hours {
            color: #0ea5e9;
            font-weight: 600;
        }
        
        .hours-progress {
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .hours-percentage {
            color: #059669;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }

        .team-member {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .team-member:last-child {
            border-bottom: none;
        }

        .member-info h4 {
            margin-bottom: 0.25rem;
        }

        .member-role {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .member-status {
            text-align: right;
        }

        .status-available {
            color: #10b981;
            font-weight: 500;
        }

        .risk-item {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            border-left: 4px solid #ef4444;
        }

        .risk-item:last-child {
            border-bottom: none;
        }

        .risk-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .risk-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f1f5f9;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e2e8f0;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 1rem;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        /* Timeline/Gantt Chart Styles */
        .timeline-container {
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 600px;
            position: relative;
        }

        .timeline-table {
            width: 100%;
            min-width: 4800px;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }

        /* Month header row */
        .month-header {
            background: #667eea !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #5a67d8 !important;
        }

        /* Today column highlighting */
        .today-column {
            background: #dbeafe !important;
            border-left: 3px solid #3b82f6 !important;
            border-right: 3px solid #3b82f6 !important;
        }

        .timeline-table th,
        .timeline-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: center;
            vertical-align: middle;
        }

        .timeline-table th {
            background: #f8fafc;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timeline-table .task-info {
            text-align: left;
            min-width: 200px;
            width: 200px;
            background: #f8fafc;
            position: sticky;
            left: 0;
            z-index: 15;
            border-right: 2px solid #d1d5db;
        }

        .timeline-table .assignee-col {
            min-width: 80px;
            width: 80px;
            background: #f8fafc;
            position: sticky;
            left: 200px;
            z-index: 15;
            border-right: 1px solid #d1d5db;
        }

        .timeline-table .progress-col {
            min-width: 60px;
            width: 60px;
            background: #f8fafc;
            position: sticky;
            left: 280px;
            z-index: 15;
            border-right: 1px solid #d1d5db;
        }

        .timeline-table .hours-col {
            min-width: 80px;
            width: 80px;
            background: #f8fafc;
            position: sticky;
            left: 340px;
            z-index: 15;
            border-right: 2px solid #d1d5db;
        }

        .date-col {
            min-width: 240px;
            width: 240px;
            font-size: 0.9rem;
            padding: 0.75rem 0.5rem;
        }

        .weekend {
            background: #f1f5f9 !important;
        }

        .today {
            background: #dbeafe !important;
            font-weight: bold;
        }
        
        /* Improve timeline responsiveness */
        @media (max-width: 768px) {
            .timeline-container {
                max-height: 400px;
            }
            
            .timeline-table .task-info {
                min-width: 150px;
                width: 150px;
            }
            
            .timeline-table .assignee-col {
                left: 150px;
            }
            
            .timeline-table .progress-col {
                left: 230px;
            }
            
            .timeline-table .hours-col {
                left: 290px;
            }
            
            .date-col {
                min-width: 180px;
                width: 180px;
                font-size: 0.8rem;
            }
        }

        .task-bar {
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            margin: 4px 3px;
            min-width: 30px;
        }

        .task-bar-complete {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .task-bar-partial {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .task-bar-not-started {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .task-bar-milestone {
            background: #8b5cf6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        .phase-header {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .task-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .task-name-timeline {
            font-weight: 500;
            font-size: 0.8rem;
        }

        .progress-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            margin: 0 auto;
        }

        .progress-100 { background: #10b981; }
        .progress-75 { background: #f59e0b; }
        .progress-50 { background: #f59e0b; }
        .progress-25 { background: #ef4444; }
        .progress-0 { background: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üï∑Ô∏è Trip.com Crawler Dashboard</h1>
        <p>Project Management & Task Tracking</p>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            Loading project data...
        </div>

        <div id="error" class="error" style="display: none;">
            Error loading project data. Please make sure the server is running and tasks.yaml exists.
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Project Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Project Progress</h3>
                    <div class="value" id="completion-percentage">74%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 74%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Total Hours</h3>
                    <div class="value" id="total-hours">192 / 260</div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem; display: flex; justify-content: space-between;">
                        <span style="color: #059669; font-weight: 600;">Actual: <span id="actual-hours-display">192h</span></span>
                        <span style="color: #0ea5e9; font-weight: 600;">Planned: <span id="planned-hours-display">260h</span></span>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem; text-align: center;">
                        <span id="hours-remaining">68 hours remaining</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Tasks Complete</h3>
                    <div class="value" id="tasks-complete">65 / 88</div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <span id="tasks-remaining">23 tasks remaining</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Team Utilization</h3>
                    <div class="value" id="team-utilization">0%</div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <span id="available-members">4 members available</span>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard -->
            <div class="dashboard-grid">
                <div class="main-content">
                    <div class="tabs">
                        <div class="tab active" onclick="showTab('tasks')">Tasks</div>
                        <div class="tab" onclick="showTab('sprint')">Current Sprint</div>
                        <div class="tab" onclick="showTab('timeline')">Timeline</div>
                    </div>

                    <div id="tasks-tab" class="tab-content active">
                        <input type="text" class="search-box" id="task-search" placeholder="Search tasks..." oninput="filterTasks()">
                        
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterByStatus('all')">All</button>
                            <button class="filter-btn" onclick="filterByStatus('not_started')">Not Started</button>
                            <button class="filter-btn" onclick="filterByStatus('partial')">In Progress</button>
                            <button class="filter-btn" onclick="filterByStatus('complete')">Complete</button>
                        </div>

                        <div id="tasks-list">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>

                    <div id="sprint-tab" class="tab-content">
                        <div class="card-header">
                            <h3>Week of October 7-13, 2025</h3>
                            <p>Capacity: <span id="sprint-capacity">40 hours</span> | Committed: <span id="sprint-committed">22 hours</span></p>
                        </div>
                        <div id="sprint-tasks">
                            <!-- Sprint tasks will be populated here -->
                        </div>
                    </div>

                    <div id="timeline-tab" class="tab-content">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <h3>üìÖ Project Timeline (Gantt Chart)</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-small" onclick="changeTimelineView('week')">Week</button>
                                <button class="btn btn-small" onclick="changeTimelineView('month')">Month</button>
                                <button class="btn btn-small" onclick="changeTimelineView('quarter')">Quarter</button>
                                <span style="margin: 0 0.5rem; color: #6b7280;">|</span>
                                <button class="btn btn-small" onclick="scrollToToday()" style="background: #10b981; color: white;">
                                    üìç Go to Today
                                </button>
                            </div>
                        </div>
                        <div class="timeline-container">
                            <table class="timeline-table" id="timeline-table">
                                <!-- Timeline table will be populated here -->
                            </table>
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <!-- Team Status -->
                    <div class="card">
                        <div class="card-header">
                            üë• Team Status
                        </div>
                        <div id="team-list">
                            <!-- Team members will be populated here -->
                        </div>
                    </div>

                    <!-- Risk Items -->
                    <div class="card">
                        <div class="card-header">
                            ‚ö†Ô∏è Risk Items
                        </div>
                        <div id="risks-list">
                            <!-- Risks will be populated here -->
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            ‚ö° Quick Actions
                        </div>
                        <div class="card-content">
                            <button class="btn" style="width: 100%; margin-bottom: 0.5rem;" onclick="exportData()">
                                üìä Export Report
                            </button>
                            <button class="btn" style="width: 100%; margin-bottom: 0.5rem;" onclick="refreshData()">
                                üîÑ Refresh Data
                            </button>
                            <button class="btn" style="width: 100%; margin-bottom: 0.5rem;" onclick="showAssignModal()">
                                üë§ Assign Task
                            </button>
                            <button class="btn" style="width: 100%; background: #10b981;" onclick="autoAssignTasks()">
                                ü§ñ Auto-Assign by Role
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Assignment Modal -->
    <div id="assign-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 1rem;">Assign Task</h3>
            <select id="task-select" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select a task...</option>
            </select>
            <select id="member-select" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">Select team member...</option>
            </select>
            <div style="display: flex; gap: 1rem;">
                <button class="btn" onclick="assignTask()">Assign</button>
                <button class="btn" style="background: #6b7280;" onclick="closeAssignModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let projectData = null;
        let filteredTasks = [];
        let currentFilter = 'all';
        let timelineView = 'month'; // week, month, quarter

        // Simple YAML parser for our specific format
        function parseYAML(yamlText) {
            const lines = yamlText.split('\n');
            const result = {};
            let currentObj = result;
            let stack = [result];
            let currentKey = null;
            
            for (let line of lines) {
                // Skip comments and empty lines
                if (line.trim().startsWith('#') || line.trim() === '') continue;
                
                const indent = line.length - line.trimLeft().length;
                const trimmed = line.trim();
                
                // Handle key-value pairs
                if (trimmed.includes(':')) {
                    const [key, ...valueParts] = trimmed.split(':');
                    const value = valueParts.join(':').trim();
                    
                    // Remove quotes if present
                    const cleanValue = value.replace(/^["']|["']$/g, '');
                    
                    if (value === '' || value === '[]') {
                        // Empty value or array
                        currentObj[key.trim()] = value === '[]' ? [] : {};
                        currentKey = key.trim();
                    } else if (cleanValue.match(/^\d+$/)) {
                        // Number
                        currentObj[key.trim()] = parseInt(cleanValue);
                    } else if (cleanValue.match(/^\d+\.\d+$/)) {
                        // Float
                        currentObj[key.trim()] = parseFloat(cleanValue);
                    } else if (cleanValue === 'true' || cleanValue === 'false') {
                        // Boolean
                        currentObj[key.trim()] = cleanValue === 'true';
                    } else if (cleanValue.startsWith('[') && cleanValue.endsWith(']')) {
                        // Array
                        const arrayContent = cleanValue.slice(1, -1);
                        currentObj[key.trim()] = arrayContent ? arrayContent.split(',').map(s => s.trim().replace(/^["']|["']$/g, '')) : [];
                    } else {
                        // String
                        currentObj[key.trim()] = cleanValue;
                    }
                } else if (trimmed.startsWith('- ')) {
                    // Array item
                    const item = trimmed.substring(2);
                    if (item.includes(':')) {
                        // Object in array
                        const obj = {};
                        const [key, ...valueParts] = item.split(':');
                        const value = valueParts.join(':').trim().replace(/^["']|["']$/g, '');
                        
                        if (value.match(/^\d+$/)) {
                            obj[key.trim()] = parseInt(value);
                        } else if (value.match(/^\d+\.\d+$/)) {
                            obj[key.trim()] = parseFloat(value);
                        } else {
                            obj[key.trim()] = value;
                        }
                        
                        if (!Array.isArray(currentObj[currentKey])) {
                            currentObj[currentKey] = [];
                        }
                        currentObj[currentKey].push(obj);
                    } else {
                        // Simple array item
                        if (!Array.isArray(currentObj[currentKey])) {
                            currentObj[currentKey] = [];
                        }
                        currentObj[currentKey].push(item.replace(/^["']|["']$/g, ''));
                    }
                }
            }
            
            return result;
        }

        // Convert YAML structure to expected JSON structure
        function convertYAMLToExpectedFormat(yamlData) {
            const converted = {
                project: yamlData.project,
                team: yamlData.team || [],
                tasks: [],
                current_sprint: yamlData.current_sprint || {},
                risks: yamlData.risks || [],
                time_logs: yamlData.time_logs || [],
                next_actions: yamlData.next_week_priorities || []
            };

            // Flatten tasks from phases
            if (yamlData.phases) {
                yamlData.phases.forEach(phase => {
                    if (phase.tasks) {
                        phase.tasks.forEach(task => {
                            // Calculate hours from arrays (handle empty arrays)
                            const plannedTotal = Array.isArray(task.planned_hours) ? 
                                (task.planned_hours.length > 0 ? task.planned_hours.reduce((a, b) => a + b, 0) : 0) : task.planned_hours || 0;
                            const actualTotal = Array.isArray(task.actual_hours) ? 
                                (task.actual_hours.length > 0 ? task.actual_hours.reduce((a, b) => a + b, 0) : 0) : task.actual_hours || 0;
                            
                            converted.tasks.push({
                                ...task,
                                phase: phase.name,
                                due_date: task.end_date,
                                hours_remaining: Math.max(0, plannedTotal - actualTotal),
                                priority: task.priority || 'medium'
                            });
                        });
                    }
                });
            }

            return converted;
        }

        // Load and initialize dashboard
        async function loadData() {
            try {
                console.log('üöÄ Starting loadData...');
                document.getElementById('loading').textContent = 'Loading API data...';
                
                // Try to load from API first (YAML converted to JSON)
                console.log('üì° Fetching /api/tasks...');
                const response = await fetch('/api/tasks');
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('üì° Parsing JSON...');
                projectData = await response.json();
                console.log('üì° Raw data received:', projectData);
                
                // Convert YAML structure to match expected JSON structure if needed
                if (projectData.phases) {
                    console.log('üîÑ Converting YAML structure...');
                    projectData = convertYAMLToExpectedFormat(projectData);
                    console.log('üîÑ Converted data:', projectData);
                }
                
                console.log('üéØ Initializing dashboard...');
                initializeDashboard();
                
                console.log('‚úÖ Dashboard loaded successfully!');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                console.error('‚ùå Error stack:', error.stack);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <h3>Error Details:</h3>
                    <p><strong>Message:</strong> ${error.message}</p>
                    <p><strong>Type:</strong> ${error.name}</p>
                    <p><strong>Stack:</strong></p>
                    <pre>${error.stack}</pre>
                `;
            }
        }

        function initializeDashboard() {
            try {
                console.log('üìä Updating stats...');
                updateStats();
                
                console.log('üìã Rendering tasks...');
                renderTasks();
                
                console.log('üë• Rendering team...');
                renderTeam();
                
                console.log('‚ö†Ô∏è Rendering risks...');
                renderRisks();
                
                console.log('üèÉ Rendering sprint...');
                renderSprint();
                
                console.log('üìÖ Rendering timeline...');
                renderTimeline();
                
                console.log('üîç Setting filtered tasks...');
                filteredTasks = projectData.tasks;
                
                console.log('‚úÖ Dashboard initialization complete!');
            } catch (error) {
                console.error('‚ùå Error in initializeDashboard:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function updateStats() {
            try {
                console.log('üìä updateStats: Starting...');
                console.log('üìä updateStats: projectData.project =', projectData.project);
                
                const completion = projectData.project.completion_percentage;
                const totalPlanned = projectData.project.total_planned_hours;
                const totalActual = projectData.project.total_actual_hours;
                
                console.log('üìä updateStats: Basic stats =', { completion, totalPlanned, totalActual });
                console.log('üìä updateStats: projectData.tasks =', projectData.tasks);
                
                const tasksComplete = projectData.tasks.filter(t => t.status === 2).length;
                const totalTasks = projectData.tasks.length;
                
                console.log('üìä updateStats: Task counts =', { tasksComplete, totalTasks });
            
                console.log('üìä updateStats: Updating DOM elements...');
                document.getElementById('completion-percentage').textContent = completion + '%';
                document.getElementById('progress-fill').style.width = completion + '%';
                document.getElementById('total-hours').textContent = `${totalActual} / ${totalPlanned}`;
                document.getElementById('actual-hours-display').textContent = `${totalActual}h`;
                document.getElementById('planned-hours-display').textContent = `${totalPlanned}h`;
                document.getElementById('hours-remaining').textContent = `${totalPlanned - totalActual} hours remaining`;
                document.getElementById('tasks-complete').textContent = `${tasksComplete} / ${totalTasks}`;
                document.getElementById('tasks-remaining').textContent = `${totalTasks - tasksComplete} tasks remaining`;
                
                console.log('üìä updateStats: Processing team data...');
                const availableMembers = projectData.team.filter(m => m.availability === 'available').length;
                document.getElementById('team-utilization').textContent = '0%';
                document.getElementById('available-members').textContent = `${availableMembers} members available`;
                
                console.log('üìä updateStats: Complete!');
            } catch (error) {
                console.error('‚ùå Error in updateStats:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function renderTasks() {
            try {
                console.log('üìã renderTasks: Starting...');
                console.log('üìã renderTasks: projectData.tasks =', projectData.tasks);
                
                const tasksList = document.getElementById('tasks-list');
                tasksList.innerHTML = '';

                console.log('üìã renderTasks: Processing', projectData.tasks.length, 'tasks...');
                projectData.tasks.forEach((task, index) => {
                    console.log(`üìã renderTasks: Processing task ${index + 1}:`, task);
                const taskItem = document.createElement('div');
                taskItem.className = `task-item priority-${task.priority}`;
                
                // Handle numeric status values
                const statusClass = task.status === 2 ? 'status-complete' : 
                                  task.status === 1 ? 'status-partial' : 'status-not-started';
                
                // Calculate hours from arrays (handle empty arrays)
                const plannedTotal = Array.isArray(task.planned_hours) ? 
                    (task.planned_hours.length > 0 ? task.planned_hours.reduce((a, b) => a + b, 0) : 0) : task.planned_hours || 0;
                const actualTotal = Array.isArray(task.actual_hours) ? 
                    (task.actual_hours.length > 0 ? task.actual_hours.reduce((a, b) => a + b, 0) : 0) : task.actual_hours || 0;
                const hoursRemaining = Math.max(0, plannedTotal - actualTotal);
                
                taskItem.innerHTML = `
                    <div class="task-status ${statusClass}"></div>
                    <div class="task-info">
                        <div class="task-id">${task.id}</div>
                        <div class="task-name">${task.name}</div>
                        <div class="task-meta">
                            ${task.assignee} ‚Ä¢ ${task.phase} ‚Ä¢ Due: ${task.due_date}
                            ${task.notes ? `‚Ä¢ ${task.notes}` : ''}
                        </div>
                    </div>
                    <div class="task-hours">
                        <div class="hours-display">
                            <span class="actual-hours">${actualTotal}h</span>
                            <span class="hours-separator">/</span>
                            <span class="planned-hours">${plannedTotal}h</span>
                        </div>
                        <div class="hours-progress" style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">
                            ${hoursRemaining}h remaining
                        </div>
                        <div class="hours-percentage" style="font-size: 0.7rem; color: #059669; font-weight: 500;">
                            ${plannedTotal > 0 ? Math.round((actualTotal / plannedTotal) * 100) : 0}% complete
                        </div>
                    </div>
                `;
                
                    tasksList.appendChild(taskItem);
                });
                
                console.log('üìã renderTasks: Complete!');
            } catch (error) {
                console.error('‚ùå Error in renderTasks:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function renderTeam() {
            try {
                console.log('üë• renderTeam: Starting...');
                console.log('üë• renderTeam: projectData.team =', projectData.team);
                
                const teamList = document.getElementById('team-list');
                teamList.innerHTML = '';

                projectData.team.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                
                memberDiv.innerHTML = `
                    <div class="member-info">
                        <h4>${member.name}</h4>
                        <div class="member-role">${member.role}</div>
                    </div>
                    <div class="member-status">
                        <div class="status-available">${member.availability}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            ${member.total_hours}h total
                        </div>
                    </div>
                `;
                
                    teamList.appendChild(memberDiv);
                });
                
                console.log('üë• renderTeam: Complete!');
            } catch (error) {
                console.error('‚ùå Error in renderTeam:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function renderRisks() {
            try {
                console.log('‚ö†Ô∏è renderRisks: Starting...');
                console.log('‚ö†Ô∏è renderRisks: projectData.risks =', projectData.risks);
                
                const risksList = document.getElementById('risks-list');
                risksList.innerHTML = '';

                projectData.risks.forEach(risk => {
                const riskDiv = document.createElement('div');
                riskDiv.className = 'risk-item';
                
                riskDiv.innerHTML = `
                    <div class="risk-name">${risk.name}</div>
                    <div class="risk-meta">
                        Impact: ${risk.impact} ‚Ä¢ Probability: ${risk.probability}
                        <br>Mitigation: ${risk.mitigation}
                    </div>
                `;
                
                    risksList.appendChild(riskDiv);
                });
                
                console.log('‚ö†Ô∏è renderRisks: Complete!');
            } catch (error) {
                console.error('‚ùå Error in renderRisks:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function renderSprint() {
            try {
                console.log('üèÉ renderSprint: Starting...');
                console.log('üèÉ renderSprint: current_sprint =', projectData.current_sprint);
                
                const sprintTasks = document.getElementById('sprint-tasks');
                const sprint = projectData.current_sprint || {};
                
                // Handle missing sprint data
                if (!sprint.capacity_hours) {
                    console.log('üèÉ renderSprint: No sprint data, using defaults');
                    document.getElementById('sprint-capacity').textContent = '40 hours';
                    document.getElementById('sprint-committed').textContent = '0 hours';
                } else {
                    document.getElementById('sprint-capacity').textContent = sprint.capacity_hours + ' hours';
                    document.getElementById('sprint-committed').textContent = sprint.committed_hours + ' hours';
                }
                
                sprintTasks.innerHTML = '';
                
                // Handle missing sprint arrays
                const inProgressTaskIds = sprint.in_progress || [];
                const highPriorityTaskIds = sprint.high_priority || [];
                
                console.log('üèÉ renderSprint: in_progress_task_ids =', inProgressTaskIds);
                console.log('üèÉ renderSprint: high_priority_task_ids =', highPriorityTaskIds);
                
                const inProgressTasks = projectData.tasks.filter(t => inProgressTaskIds.includes(t.id));
                const highPriorityTasks = projectData.tasks.filter(t => highPriorityTaskIds.includes(t.id));
            
            // In Progress Section
            if (inProgressTasks.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = '<h4 style="padding: 1rem; background: #f8fafc; margin: 0;">üîÑ In Progress</h4>';
                sprintTasks.appendChild(section);
                
                inProgressTasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task-item';
                    taskDiv.innerHTML = `
                        <div class="task-status status-partial"></div>
                        <div class="task-info">
                            <div class="task-id">${task.id}</div>
                            <div class="task-name">${task.name}</div>
                            <div class="task-meta">${task.assignee} ‚Ä¢ ${task.hours_remaining}h remaining</div>
                        </div>
                    `;
                    sprintTasks.appendChild(taskDiv);
                });
            }
            
            // High Priority Section
            if (highPriorityTasks.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = '<h4 style="padding: 1rem; background: #fef2f2; margin: 0;">üî• High Priority</h4>';
                sprintTasks.appendChild(section);
                
                highPriorityTasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task-item';
                    taskDiv.innerHTML = `
                        <div class="task-status status-not-started"></div>
                        <div class="task-info">
                            <div class="task-id">${task.id}</div>
                            <div class="task-name">${task.name}</div>
                            <div class="task-meta">${task.assignee} ‚Ä¢ ${task.hours_remaining}h remaining</div>
                        </div>
                    `;
                    sprintTasks.appendChild(taskDiv);
                });
            }
            
            console.log('üèÉ renderSprint: Complete!');
            } catch (error) {
                console.error('‚ùå Error in renderSprint:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function filterTasks() {
            const searchTerm = document.getElementById('task-search').value.toLowerCase();
            const taskItems = document.querySelectorAll('#tasks-list .task-item');
            
            taskItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                const matches = text.includes(searchTerm);
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function filterByStatus(status) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const taskItems = document.querySelectorAll('#tasks-list .task-item');
            
            taskItems.forEach(item => {
                const statusElement = item.querySelector('.task-status');
                let taskStatus = 'not_started';
                
                if (statusElement.classList.contains('status-complete')) taskStatus = 'complete';
                else if (statusElement.classList.contains('status-partial')) taskStatus = 'partial';
                
                const matches = status === 'all' || taskStatus === status;
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function showAssignModal() {
            const modal = document.getElementById('assign-modal');
            const taskSelect = document.getElementById('task-select');
            const memberSelect = document.getElementById('member-select');
            
            // Populate task options
            taskSelect.innerHTML = '<option value="">Select a task...</option>';
            projectData.tasks.filter(t => t.assignee === 'TBD').forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `${task.id} - ${task.name}`;
                taskSelect.appendChild(option);
            });
            
            // Populate member options
            memberSelect.innerHTML = '<option value="">Select team member...</option>';
            projectData.team.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = `${member.name} (${member.role})`;
                memberSelect.appendChild(option);
            });
            
            modal.style.display = 'block';
        }

        function closeAssignModal() {
            document.getElementById('assign-modal').style.display = 'none';
        }

        function assignTask() {
            const taskId = document.getElementById('task-select').value;
            const memberName = document.getElementById('member-select').value;
            
            if (!taskId || !memberName) {
                alert('Please select both a task and team member');
                return;
            }
            
            // Update the task in memory (in a real app, this would save to backend)
            const task = projectData.tasks.find(t => t.id === taskId);
            if (task) {
                task.assignee = memberName;
                renderTasks();
                renderSprint();
                alert(`Task ${taskId} assigned to ${memberName}`);
            }
            
            closeAssignModal();
        }

        function exportData() {
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'project-export.json';
            link.click();
        }

        function refreshData() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            loadData();
        }

        // Auto-assignment based on roles
        function autoAssignTasks() {
            if (!confirm('This will automatically assign unassigned tasks based on team member roles. Continue?')) {
                return;
            }

            const assignmentRules = {
                'Senior Developer': [
                    'logging', 'monitoring', 'session', 'persistence', 'cookie', 'stealth', 'fingerprint', 
                    'browser', 'crawler', 'extraction', 'implementation', 'development', 'coding'
                ],
                'Quality Assurance': [
                    'test', 'testing', 'validation', 'verify', 'quality', 'bug', 'scenario', 'coverage'
                ],
                'DevOps Engineer': [
                    'docker', 'containerization', 'ci/cd', 'pipeline', 'deployment', 'infrastructure', 
                    'server', 'production', 'environment', 'configuration'
                ]
            };

            let assignmentCount = 0;
            const assignments = [];

            // Get available team members
            const availableMembers = projectData.team.filter(member => member.availability === 'available');
            
            // Get unassigned tasks
            const unassignedTasks = projectData.tasks.filter(task => task.assignee === 'TBD' && task.status !== 2);

            unassignedTasks.forEach(task => {
                const bestMatch = findBestAssignee(task, availableMembers, assignmentRules);
                if (bestMatch) {
                    task.assignee = bestMatch.name;
                    assignments.push({
                        taskId: task.id,
                        taskName: task.name,
                        assignee: bestMatch.name,
                        role: bestMatch.role,
                        reason: getBestMatchReason(task, bestMatch, assignmentRules)
                    });
                    assignmentCount++;
                }
            });

            if (assignmentCount > 0) {
                // Update the UI
                renderTasks();
                renderSprint();
                renderTimeline();
                
                // Show assignment summary
                showAssignmentSummary(assignments);
                
                alert(`‚úÖ Successfully assigned ${assignmentCount} tasks based on team roles!`);
            } else {
                alert('‚ÑπÔ∏è No unassigned tasks found or no suitable assignees available.');
            }
        }

        function findBestAssignee(task, availableMembers, assignmentRules) {
            let bestMatch = null;
            let highestScore = 0;

            availableMembers.forEach(member => {
                const score = calculateAssignmentScore(task, member, assignmentRules);
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = member;
                }
            });

            return bestMatch;
        }

        function calculateAssignmentScore(task, member, assignmentRules) {
            const roleKeywords = assignmentRules[member.role] || [];
            const taskText = (task.name + ' ' + task.phase + ' ' + (task.notes || '')).toLowerCase();
            
            let score = 0;
            
            // Base score for role match
            roleKeywords.forEach(keyword => {
                if (taskText.includes(keyword.toLowerCase())) {
                    score += 10;
                }
            });

            // Priority bonus
            if (task.priority === 'high') score += 5;
            if (task.priority === 'medium') score += 2;

            // Phase-specific bonuses
            if (member.role === 'Senior Developer' && 
                (task.phase === 'Core Development' || task.phase === 'Stealth Features')) {
                score += 15;
            }
            
            if (member.role === 'Quality Assurance' && task.phase === 'Testing') {
                score += 20;
            }
            
            if (member.role === 'DevOps Engineer' && 
                (task.phase === 'Deployment' || task.phase === 'Configuration & Deployment')) {
                score += 20;
            }

            // Workload balancing (prefer members with fewer tasks)
            const memberTasks = projectData.tasks.filter(t => t.assignee === member.name && t.status !== 2);
            score -= memberTasks.length * 3;

            return score;
        }

        function getBestMatchReason(task, member, assignmentRules) {
            const roleKeywords = assignmentRules[member.role] || [];
            const taskText = (task.name + ' ' + task.phase).toLowerCase();
            
            const matchedKeywords = roleKeywords.filter(keyword => 
                taskText.includes(keyword.toLowerCase())
            );

            if (matchedKeywords.length > 0) {
                return `Role expertise: ${matchedKeywords.slice(0, 2).join(', ')}`;
            }
            
            if (member.role === 'Senior Developer' && 
                (task.phase === 'Core Development' || task.phase === 'Stealth Features')) {
                return 'Phase specialization: Development tasks';
            }
            
            if (member.role === 'Quality Assurance' && task.phase === 'Testing') {
                return 'Phase specialization: Testing tasks';
            }
            
            if (member.role === 'DevOps Engineer' && task.phase === 'Deployment') {
                return 'Phase specialization: Deployment tasks';
            }

            return 'Best available match';
        }

        function showAssignmentSummary(assignments) {
            let summaryHTML = '<div style="max-height: 400px; overflow-y: auto;">';
            summaryHTML += '<h4 style="margin-bottom: 1rem;">üìã Assignment Summary</h4>';
            
            assignments.forEach(assignment => {
                summaryHTML += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="font-weight: bold; color: #374151;">${assignment.taskId} - ${assignment.taskName}</div>
                        <div style="color: #667eea; font-size: 0.9rem;">üë§ ${assignment.assignee} (${assignment.role})</div>
                        <div style="color: #6b7280; font-size: 0.8rem;">üí° ${assignment.reason}</div>
                    </div>
                `;
            });
            
            summaryHTML += '</div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    ${summaryHTML}
                    <button class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="margin-top: 1rem; width: 100%;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Timeline/Gantt Chart Functions
        function renderTimeline() {
            try {
                console.log('üìÖ renderTimeline: Starting...');
                console.log('üìÖ renderTimeline: projectData.tasks =', projectData.tasks);
                
                const timelineTable = document.getElementById('timeline-table');
                const dates = generateDateRange();
                
                // Generate month headers
                const monthHeaders = generateMonthHeaders(dates);
            
                // Create header with month row
                let headerHTML = `
                    <thead>
                        <tr>
                            <th class="task-info" rowspan="2">Task</th>
                            <th class="assignee-col" rowspan="2">Assignee</th>
                            <th class="progress-col" rowspan="2">Progress</th>
                            <th class="hours-col" rowspan="2">Hours</th>
                            ${monthHeaders.map(month => `<th class="month-header" colspan="${month.colspan}">${month.name}</th>`).join('')}
                        </tr>
                        <tr>
                            ${dates.map(date => {
                                const dateClass = getDateClass(date);
                                const todayClass = isToday(date) ? 'today-column' : '';
                                return `<th class="date-col ${dateClass} ${todayClass}" data-date="${date.toISOString().split('T')[0]}">${formatDateHeader(date)}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                `;
            
            // Group tasks by phase
            const phases = {};
            projectData.tasks.forEach(task => {
                if (!phases[task.phase]) {
                    phases[task.phase] = [];
                }
                phases[task.phase].push(task);
            });
            
            // Create body
            let bodyHTML = '<tbody>';
            
            Object.keys(phases).forEach(phaseName => {
                // Phase header row
                bodyHTML += `
                    <tr class="phase-header">
                        <td class="task-info" style="background: #667eea; color: white;">${phaseName}</td>
                        <td class="assignee-col" style="background: #667eea;"></td>
                        <td class="progress-col" style="background: #667eea;"></td>
                        <td class="hours-col" style="background: #667eea;"></td>
                        ${dates.map(() => '<td style="background: #667eea;"></td>').join('')}
                    </tr>
                `;
                
                // Task rows - now with separate planned and actual rows
                phases[phaseName].forEach(task => {
                    // Calculate totals from arrays (handle empty arrays)
                    const plannedTotal = Array.isArray(task.planned_hours) ? 
                        (task.planned_hours.length > 0 ? task.planned_hours.reduce((a, b) => a + b, 0) : 0) : task.planned_hours || 0;
                    const actualTotal = Array.isArray(task.actual_hours) ? 
                        (task.actual_hours.length > 0 ? task.actual_hours.reduce((a, b) => a + b, 0) : 0) : task.actual_hours || 0;
                    const progressPercent = plannedTotal > 0 ? Math.round((actualTotal / plannedTotal) * 100) : 0;
                    const progressClass = getProgressClass(progressPercent);
                    
                    // Planned hours row
                    bodyHTML += `
                        <tr>
                            <td class="task-info" style="border-bottom: none;">
                                <div class="task-id">${task.id}</div>
                                <div class="task-name-timeline">${task.name}</div>
                            </td>
                            <td class="assignee-col" style="border-bottom: none;" rowspan="2">${task.assignee}</td>
                            <td class="progress-col" style="border-bottom: none;" rowspan="2">
                                <div class="progress-circle ${progressClass}">${progressPercent}%</div>
                            </td>
                            <td class="hours-col" style="border-bottom: none; background: #e0f2fe; font-weight: bold;">
                                <div style="font-size: 0.75rem; color: #0277bd; font-weight: 600;">PLANNED</div>
                                <div style="font-size: 1rem; color: #0277bd; font-weight: 700;">${plannedTotal}h</div>
                            </td>
                            ${dates.map(date => {
                                const dateClass = getDateClass(date);
                                const todayClass = isToday(date) ? 'today-column' : '';
                                return `<td class="date-col ${dateClass} ${todayClass}" style="border-bottom: none;">${getPlannedBarForDate(task, date)}</td>`;
                            }).join('')}
                        </tr>
                    `;
                    
                    // Actual hours row
                    bodyHTML += `
                        <tr style="border-top: none;">
                            <td class="task-info" style="border-top: none; padding-left: 2rem; font-size: 0.75rem; color: #6b7280;">
                                <div style="font-style: italic;">Progress tracking</div>
                            </td>
                            <td class="hours-col" style="border-top: none; background: #f0fdf4; font-weight: bold;">
                                <div style="font-size: 0.75rem; color: #15803d; font-weight: 600;">ACTUAL</div>
                                <div style="font-size: 1rem; color: #15803d; font-weight: 700;">${actualTotal}h</div>
                            </td>
                            ${dates.map(date => {
                                const dateClass = getDateClass(date);
                                const todayClass = isToday(date) ? 'today-column' : '';
                                return `<td class="date-col ${dateClass} ${todayClass}" style="border-top: none;">${getActualBarForDate(task, date)}</td>`;
                            }).join('')}
                        </tr>
                    `;
                });
            });
            
            bodyHTML += '</tbody>';
                timelineTable.innerHTML = headerHTML + bodyHTML;
                
                // Auto-scroll to today's column
                setTimeout(() => {
                    scrollToToday();
                }, 100);
                
                console.log('üìÖ renderTimeline: Complete!');
            } catch (error) {
                console.error('‚ùå Error in renderTimeline:', error);
                console.error('‚ùå Error stack:', error.stack);
                throw error;
            }
        }
        
        function generateDateRange() {
            const dates = [];
            let startDate, endDate, increment;
            
            if (timelineView === 'week') {
                startDate = new Date('2025-10-06'); // Monday of current week
                endDate = new Date('2025-10-19'); // Two weeks
                increment = 1; // days
            } else if (timelineView === 'month') {
                startDate = new Date('2025-09-01');
                endDate = new Date('2025-11-30');
                increment = 1; // days
            } else { // quarter
                startDate = new Date('2025-09-01');
                endDate = new Date('2025-12-31');
                increment = 7; // weeks
            }
            
            const current = new Date(startDate);
            while (current <= endDate) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + increment);
            }
            
            return dates;
        }
        
        function formatDateHeader(date) {
            if (timelineView === 'week') {
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
            } else if (timelineView === 'month') {
                return date.getDate().toString();
            } else {
                return `W${getWeekNumber(date)}`;
            }
        }
        
        function getDateClass(date) {
            const today = new Date();
            const isTodayDate = date.toDateString() === today.toDateString();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            if (isTodayDate) return 'today';
            if (isWeekend) return 'weekend';
            return '';
        }
        
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        
        function generateMonthHeaders(dates) {
            const monthHeaders = [];
            let currentMonth = null;
            let currentCount = 0;
            
            dates.forEach(date => {
                const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                if (currentMonth !== monthYear) {
                    if (currentMonth !== null) {
                        monthHeaders.push({
                            name: currentMonth,
                            colspan: currentCount
                        });
                    }
                    currentMonth = monthYear;
                    currentCount = 1;
                } else {
                    currentCount++;
                }
            });
            
            // Add the last month
            if (currentMonth !== null) {
                monthHeaders.push({
                    name: currentMonth,
                    colspan: currentCount
                });
            }
            
            return monthHeaders;
        }
        
        function scrollToToday() {
            const container = document.querySelector('.timeline-container');
            const todayColumn = document.querySelector('.today-column');
            
            if (container && todayColumn) {
                const containerRect = container.getBoundingClientRect();
                const todayRect = todayColumn.getBoundingClientRect();
                
                // Calculate scroll position to center today's column
                const scrollLeft = todayColumn.offsetLeft - (container.clientWidth / 2) + (todayColumn.offsetWidth / 2);
                
                container.scrollTo({
                    left: Math.max(0, scrollLeft),
                    behavior: 'smooth'
                });
                
                console.log('üìÖ Auto-scrolled to today:', new Date().toDateString());
            }
        }
        
        function getProgressClass(percent) {
            if (percent >= 100) return 'progress-100';
            if (percent >= 75) return 'progress-75';
            if (percent >= 50) return 'progress-50';
            if (percent >= 25) return 'progress-25';
            return 'progress-0';
        }
        
        function getPlannedBarForDate(task, date) {
            const taskStart = new Date(task.start_date);
            const taskEnd = new Date(task.due_date);
            const currentDate = new Date(date);
            
            // Check if this date falls within the task duration
            if (currentDate >= taskStart && currentDate <= taskEnd) {
                // Calculate which day this is in the task (0-based index)
                const dayIndex = Math.floor((currentDate - taskStart) / (1000 * 60 * 60 * 24));
                
                // Get planned hours for this specific day
                const plannedHours = Array.isArray(task.planned_hours) ? task.planned_hours : [];
                const hoursForThisDay = plannedHours[dayIndex] || 0;
                
                if (hoursForThisDay > 0) {
                    const barHeight = timelineView === 'week' ? '28px' : '24px';
                    return `<div class="task-bar" style="background: linear-gradient(90deg, #3b82f6, #1e40af); height: ${barHeight}; color: white; font-weight: bold; font-size: 0.75rem;">${hoursForThisDay}h</div>`;
                }
            }
            
            return '';
        }

        function getActualBarForDate(task, date) {
            const taskStart = new Date(task.start_date);
            const taskEnd = new Date(task.due_date);
            const currentDate = new Date(date);
            
            // Check if this date falls within the task duration
            if (currentDate >= taskStart && currentDate <= taskEnd) {
                // Calculate which day this is in the task (0-based index)
                const dayIndex = Math.floor((currentDate - taskStart) / (1000 * 60 * 60 * 24));
                
                // Get actual hours for this specific day
                const actualHours = Array.isArray(task.actual_hours) ? task.actual_hours : [];
                const hoursForThisDay = actualHours[dayIndex] || 0;
                
                if (hoursForThisDay > 0) {
                    const barHeight = timelineView === 'week' ? '28px' : '24px';
                    
                    // Color based on task status
                    let backgroundColor;
                    if (task.status === 2) {
                        backgroundColor = 'linear-gradient(90deg, #10b981, #059669)'; // Complete - green
                    } else if (task.status === 1) {
                        backgroundColor = 'linear-gradient(90deg, #f59e0b, #d97706)'; // In progress - orange
                    } else {
                        backgroundColor = 'linear-gradient(90deg, #6b7280, #4b5563)'; // Not started - gray
                    }
                    
                    return `<div class="task-bar" style="background: ${backgroundColor}; height: ${barHeight}; color: white; font-weight: bold; font-size: 0.75rem;">${hoursForThisDay}h</div>`;
                }
            }
            
            return '';
        }

        // Keep the old function for backward compatibility
        function getTaskBarForDate(task, date) {
            return getPlannedBarForDate(task, date);
        }
        
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        function changeTimelineView(view) {
            timelineView = view;
            
            // Update button states
            document.querySelectorAll('.btn-small').forEach(btn => {
                btn.style.background = btn.textContent.toLowerCase() === view ? '#667eea' : '#f1f5f9';
                btn.style.color = btn.textContent.toLowerCase() === view ? 'white' : '#374151';
            });
            
            renderTimeline();
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
